<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GoFile Downloader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            /* Changed background URL to a Picsum image */
            background: url('https://picsum.photos/1920/1080') no-repeat center center fixed !important;
            background-size: cover !important;
        }
        .content-wrapper {
            background-color: rgba(255,255,255,0.85);
            padding: 2rem;
            border-radius: 10px;
        }
        .dark-mode .content-wrapper {
            background-color: rgba(0,0,0,0.85);
            color: #e0e0e0;
        }
        .logo {
            max-width: 120px;
            margin-bottom: 1rem;
        }
        h1 {
            font-size: 2rem; /* Reduced font-size so it aligns with the logo's size */
        }
        /* Style for file browsing frame */
        .file-frame {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 0.5rem;
            background-color: #f9f9f9;
        }
        .dark-mode .file-frame {
            background-color: #333;
            border-color: #555;
        }
    </style>
</head>
<body class="p-4">
    <div class="container content-wrapper">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <!-- Updated header: GoFile logo with downloader text next to it -->
                <img src="https://gofile.io/dist/img/logo-big.png" alt="GoFile Logo" class="logo me-2">
                <h1 class="mb-0">Downloader</h1>
            </div>
            <!-- Dark/Light Mode Toggle -->
            <button id="mode-toggle" class="btn btn-outline-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-brightness-high" viewBox="0 0 16 16">
                  <path d="M8 4.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm0 1a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5z"/>
                  <path d="M8 0a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5zm7-5a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1 0-1h1a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5H1a.5.5 0 0 1 0-1h1.5A.5.5 0 0 1 3 8zm9.657-4.657a.5.5 0 1 1-.707.707l-.708-.707a.5.5 0 1 1 .708-.708l.707.708zm-8.485 8.485a.5.5 0 1 1-.707.707l-.707-.707a.5.5 0 1 1 .707-.707l.707.707zm8.485 0l.707.707a.5.5 0 0 1-.707.707l-.707-.707a.5.5 0 0 1 .707-.707zm-8.485-8.485l.707.707a.5.5 0 1 1-.707.707l-.707-.707a.5.5 0 1 1 .707-.707z"/>
                </svg>
                Toggle Mode
            </button>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        <form id="download-form" class="mb-3">
            <div class="mb-3">
                <label for="url" class="form-label">GoFile URL</label>
                <input type="text" class="form-control" id="url" name="url" placeholder="https://gofile.io/d/foobar" required>
            </div>
            <div class="mb-3">
                <label for="directory" class="form-label">Download Directory</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="directory" name="directory" placeholder="/app">
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#directoryModal">Browse</button>
                </div>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password (if any)</label>
                <input type="text" class="form-control" id="password" name="password" placeholder="Password">
            </div>
            <button type="submit" class="btn btn-primary">Start Download</button>
        </form>

        <!-- Filter Controls -->
        <div class="mb-3">
            <label for="filter-select" class="form-label">Show tasks older than:</label>
            <select id="filter-select" class="form-select" style="width: auto; display: inline-block;">
                <option value="0">All</option>
                <option value="1">1 day</option>
                <option value="7">7 days</option>
                <option value="30">30 days</option>
                <option value="180">180 days</option>
                <option value="365">365 days</option>
            </select>
        </div>

        <!-- Tasks Panel -->
        <h2 class="mt-4">Download Tasks</h2>
        <div id="tasks-panel">
            <!-- Tasks will be injected here -->
        </div>
    </div>

    <!-- Add a toast container inside the body, for example right after the closing </div> of content-wrapper: -->
    <div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;"></div>

    <!-- Updated Modal: Directory Browsing -->
    <div class="modal fade" id="directoryModal" tabindex="-1" aria-labelledby="directoryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="directoryModalLabel">Browse File System</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Two-column layout: left for tree, right for manual entry -->
            <div class="row">
                <div class="col-md-6">
                    <div class="file-frame" id="folder-tree">
                        <!-- File tree loaded dynamically -->
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="manual-path" class="form-label">Or enter path:</label>
                    <input type="text" id="manual-path" class="form-control" placeholder="Enter folder path">
                    <button id="load-manual" class="btn btn-secondary mt-2">Load</button>
                </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="select-dir" type="button" class="btn btn-primary">Select</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPath = "";

        function loadDirectories(path="") {
            fetch('/browse?path=' + encodeURIComponent(path))
                .then(response => response.json())
                .then(data => {
                    currentPath = data.current;
                    const tree = document.getElementById("folder-tree");
                    tree.innerHTML = "";
                    const ul = document.createElement("ul");
                    ul.className = "list-group";
                    // "Go up" button if not at base
                    if (currentPath) {
                        const li = document.createElement("li");
                        li.className = "list-group-item";
                        li.style.cursor = "pointer";
                        li.textContent = "..";
                        li.onclick = () => {
                            let parts = currentPath.split("/");
                            parts.pop();
                            loadDirectories(parts.join("/"));
                        };
                        ul.appendChild(li);
                    }
                    data.directories.forEach(dir => {
                        const li = document.createElement("li");
                        li.className = "list-group-item";
                        li.style.cursor = "pointer";
                        li.textContent = dir;
                        li.onclick = () => loadDirectories(currentPath ? currentPath + "/" + dir : dir);
                        ul.appendChild(li);
                    });
                    tree.appendChild(ul);
                });
        }

        // Modal: load file tree when opened
        const directoryModal = document.getElementById('directoryModal');
        directoryModal.addEventListener('shown.bs.modal', () => {
            loadDirectories("");
        });

        // Manual path load button
        document.getElementById("load-manual").addEventListener("click", () => {
            const manualPath = document.getElementById("manual-path").value;
            loadDirectories(manualPath);
        });

        // On modal select, set the chosen directory into input field
        document.getElementById("select-dir").addEventListener("click", () => {
            document.getElementById('directory').value = currentPath ? currentPath : "";
            const modal = bootstrap.Modal.getInstance(document.getElementById('directoryModal'));
            modal.hide();
        });

        // Toggle dark/light mode
        document.getElementById("mode-toggle").addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
        });

        // Toast notification function (ensure a toast container exists in your body)
        function showToast(message, type = 'info') {
            const container = document.getElementById("toast-container");
            const toast = document.createElement("div");
            toast.className = `toast align-items-center text-bg-${type} border-0`;
            toast.role = "alert";
            toast.ariaLive = "assertive";
            toast.ariaAtomic = "true";
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            container.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', () => container.removeChild(toast));
        }

        // Update form submission to use a non-blocking toast notification
        document.getElementById("download-form").addEventListener("submit", function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            fetch("/start", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'danger');
                } else {
                    showToast("Download started, task id: " + data.task_id, 'success');
                    loadTasks();
                }
            });
        });

        // Get current filter in days (0 means all)
        function getFilterDays() {
            return parseInt(document.getElementById("filter-select").value);
        }
        
        // Polling function to update tasks panel every 3 seconds
        function loadTasks() {
            fetch("/tasks")
            .then(response => response.json())
            .then(tasks => {
                const panel = document.getElementById("tasks-panel");
                panel.innerHTML = "";
                const now = Date.now() / 1000; // seconds
                const filterDays = getFilterDays();
                for(const [taskId, info] of Object.entries(tasks)) {
                    // If filter is applied, skip tasks newer than threshold
                    if(filterDays > 0 && (now - info.timestamp) < filterDays * 86400) {
                        continue;
                    }
                    const card = document.createElement("div");
                    card.className = "card mb-2";
                    const body = document.createElement("div");
                    body.className = "card-body";
                    // Format timestamp to readable date
                    const date = new Date(info.timestamp * 1000).toLocaleString();
                    const isPaused = info.paused;
                    const pauseButtonText = isPaused ? "Resume" : "Pause";
                    
                    body.innerHTML = `<div class="d-flex justify-content-between">
                            <h5 class="card-title">${info.name}</h5>
                            <div>
                              <button class="btn btn-sm btn-secondary me-1" onclick="removeTask('${taskId}')">X</button>
                              <button class="btn btn-sm btn-danger" onclick="deleteTask('${taskId}')">Delete</button>
                            </div>
                        </div>
                        <p class="card-text">URL: ${info.url}<br>Started: ${date}</p>
                        <p>Status: <span id="status-${taskId}">${info.status}</span></p>
                        <p>Overall Progress: <span id="overall-${taskId}">${info.overall_progress || 0}%</span> 
                           | ETA: <span id="eta-${taskId}">${info.eta || "N/A"}</span></p>
                        <div class="progress mb-2">
                          <div id="progress-${taskId}" class="progress-bar" role="progressbar" style="width: ${info.progress}%;">${info.progress}%</div>
                        </div>
                        ${info.files.map(f => `
                           <div class="ms-3 mb-1">
                             <strong>${f.file.split('/').pop()}</strong>: <span>${f.progress}%</span>
                             <div class="progress" style="height: 5px;">
                               <div class="progress-bar" role="progressbar" style="width: ${f.progress}%"></div>
                             </div>
                           </div>
                        `).join('')}
                        <button class="btn btn-warning btn-sm me-2" onclick="pauseTask('${taskId}')">${pauseButtonText}</button>
                        <button class="btn btn-danger btn-sm" onclick="cancelTask('${taskId}')">Cancel</button>`;
                    card.appendChild(body);
                    panel.appendChild(card);
                }
            });
        }

        // Poll tasks every 3 seconds and when filter changes
        setInterval(loadTasks, 3000);
        document.getElementById("filter-select").addEventListener("change", loadTasks);
        loadTasks();

        // Update removeTask, cancelTask and pauseTask functions to use showToast instead of alert.
        function removeTask(taskId) {
            fetch("/remove/" + taskId, { method: "POST" })
            .then(response => response.json())
            .then(data => {
                showToast(data.message || data.error, 'info');
                loadTasks();
            });
        }

        function cancelTask(taskId) {
            fetch("/cancel/" + taskId, { method: "POST" })
            .then(response => response.json())
            .then(data => {
                showToast("Task " + taskId + " cancelled.", 'warning');
                loadTasks();
            });
        }

        function pauseTask(taskId) {
            fetch("/pause/" + taskId, { method: "POST" })
            .then(response => response.json())
            .then(data => {
                const isPaused = data.paused;
                const buttonText = isPaused ? "Resume" : "Pause";
                const buttonStatus = data.status || (isPaused ? "paused" : "running");
                
                // Update the button text
                const button = document.querySelector(`button[onclick="pauseTask('${taskId}')"]`);
                if (button) {
                    button.textContent = buttonText;
                }
                
                // Update the status text
                const statusSpan = document.getElementById(`status-${taskId}`);
                if (statusSpan) {
                    statusSpan.textContent = buttonStatus;
                }
                
                showToast(`Task ${taskId} ${isPaused ? "paused" : "resumed"}`, 'info');
            })
            .catch(error => {
                console.error("Error toggling pause:", error);
                showToast("Failed to toggle pause state", 'danger');
            });
        }

        function deleteTask(taskId) {
            if (confirm("Are you sure you want to delete this task's files from disk?")) {
                fetch("/delete/" + taskId, { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    showToast(data.message || data.error, 'info');
                    loadTasks();
                });
            }
        }
    </script>
</body>
</html>
